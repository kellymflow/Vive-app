<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MBTI ì†Œê°œíŒ… ê²Œì„ â€” ëŸ°ì²˜/ëŒ€í™” íŒì—… í†µí•© ë¹Œë“œ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet"/>
  <meta name="mobile-web-app-capable" content="yes"/>
  <style>
    :root{ --pink-50:#fff1f5; --pink-100:#ffe4ec; --pink-200:#ffc9da; --pink-300:#ffabc7; --pink-400:#ff8fb5; --pink-500:#ff6a9a; --pink-600:#e45487; --pink-700:#c24373; }
    html,body{height:100%}
    body{font-family:'Noto Sans KR',sans-serif; background: radial-gradient(1200px 600px at 50% -10%, var(--pink-100), transparent), linear-gradient(180deg, var(--pink-50), #fff);}    
    .soft-card{ background:#fff; border:1px solid #f3e5ea; border-radius:1.25rem; box-shadow:0 12px 30px rgba(255,106,154,0.08);}  
    .chip{ background: var(--pink-100); color:#b4235b; }
    .btn-pink{ background: var(--pink-500); color:#fff; }
    .btn-pink:hover{ background: var(--pink-600);} 
    .dialogue-bubble{ position:relative; background:#fff; border:1px solid #f3e5ea; border-radius:.9rem; padding:1rem 1.1rem; max-width:80%; align-self:flex-start; }
    #effects-layer{ position:absolute; inset:0; pointer-events:none; overflow:hidden; }
    .badge{ font-variant-numeric: tabular-nums; }
    .particle{ position:absolute; width:18px; height:18px; opacity:0; will-change: transform, opacity; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.15));}
    .particle.pos{ animation: rise .9s ease-out forwards; }
    .particle.neg{ animation: fall .9s cubic-bezier(.2,.8,.2,1) forwards; }
    @keyframes rise{ 0%{opacity:0; transform: translate(var(--x,0), var(--y,0)) scale(.6);} 15%{opacity:1;} 100%{opacity:0; transform: translate(calc(var(--x)*1.4), calc(var(--y) - 90px)) scale(1.05);} }
    @keyframes fall{ 0%{opacity:0; transform: translate(var(--x,0), var(--y,0)) scale(.9);} 10%{opacity:1;} 100%{opacity:0; transform: translate(calc(var(--x)*1.2), calc(var(--y) + 100px)); } }
    #final-layer{ position:fixed; inset:0; pointer-events:none; z-index:70; overflow:hidden; }
    .celebration{ position:fixed; inset:0; pointer-events:none; }
    .celebration .burst{ position:absolute; font-size:28px; animation: pop2 1.2s ease-out forwards; }
    @keyframes pop2{ 0%{ transform: scale(.6); opacity:0;} 20%{opacity:1;} 100%{ transform: scale(1.35) translateY(-10px); opacity:0;} }
    #toast{ position:fixed; left:50%; transform:translateX(-50%); bottom:20px; display:flex; flex-direction:column; align-items:center; pointer-events:none; z-index:80; }
    .toast-item{ padding:.7rem 1.05rem; border-radius:9999px; color:#fff; font-weight:800; box-shadow:0 8px 24px rgba(0,0,0,.12); opacity:0; transform:translateY(10px); transition:all .25s ease; font-size:15px; letter-spacing:.2px; margin-top:.35rem; }
    .toast-item.show{ opacity:1; transform:translateY(0);} 
    #reply-pop{ position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); z-index:85; pointer-events:none; }
    .reply-card{ background:#fff; border:1px solid #f3e5ea; border-radius:1rem; padding:.9rem 1.1rem; box-shadow:0 12px 30px rgba(0,0,0,.12); max-width:90vw; width:22rem; opacity:0; transform:translateY(8px); transition: all .22s ease; text-align:center; }
    .reply-card.show{ opacity:1; transform:translateY(0); }
  </style>
</head>
<body class="min-h-screen p-4">
<div id="toast"></div>
<div id="reply-pop"></div>
<div id="final-layer"></div>

<!-- ëŸ°ì²˜ -->
<section id="launcher" class="max-w-md mx-auto space-y-5">
  <header class="text-center space-y-3">
    <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full chip text-sm font-bold">ì†Œê°œíŒ… ì‹œë®¬ë ˆì´í„°</div>
    <h1 class="text-3xl font-extrabold text-[#c24373] tracking-tight">ì˜¤ëŠ˜ì€ ëˆ„êµ¬ë‘ ì„¤ë ˆë³¼ê¹Œìš”?</h1>
    <p class="text-gray-600">ì›í•˜ëŠ” MBTIë¥¼ ê³ ë¥´ê³  ì‹œì‘í•˜ì„¸ìš”.</p>
  </header>
  <div class="soft-card p-4 space-y-4">
    <div class="grid grid-cols-4 gap-2" id="row1"></div>
    <div class="grid grid-cols-4 gap-2" id="row2"></div>
    <button id="randomBtn" type="button" class="w-full btn-pink font-bold py-3 rounded-xl">ëœë¤ ë§¤ì¹­</button>
  </div>
</section>

<!-- ê²Œì„ ì»¨í…Œì´ë„ˆ -->
<section id="game-root" class="hidden max-w-md mx-auto mt-5">
  <div id="game-container" class="relative soft-card p-6 space-y-5">
    <div class="flex items-center justify-between">
      <button id="backBtn" class="text-sm text-[#c24373] hover:underline" type="button">â† MBTI ì„ íƒìœ¼ë¡œ</button>
      <div class="text-right"><span id="target-chip" class="inline-flex items-center text-xs font-bold px-2 py-1 rounded-full chip"></span></div>
    </div>

    <div id="effects-layer"></div>

    <div class="space-y-2">
      <div class="flex justify-between items-center"><span class="text-sm font-bold text-gray-600">í˜„ì¬ ì—ë„ˆì§€</span><span id="score-text" class="text-lg font-bold text-[#e45487]">100 / 200</span></div>
      <div class="w-full bg-pink-100 rounded-full h-3"><div id="score-bar-inner" class="h-3 rounded-full" style="width: 50%; background: linear-gradient(90deg, var(--pink-300), var(--pink-500));"></div></div>
      <div class="flex justify-between items-center"><div class="flex items-center gap-2"><span class="text-sm text-gray-600">ì‹¤ìˆ˜</span><span id="strike-badge" class="badge text-xs px-2 py-1 rounded-full bg-pink-50 border">0 / 3</span></div><div class="text-sm text-gray-500"><span id="progress-text">1 / 5</span></div></div>
    </div>

    <div id="dialogue-area" class="space-y-3 min-h-[120px] max-h-[220px] flex flex-col overflow-hidden"></div>
    <div id="options-area" class="space-y-3"></div>

    <div id="result-modal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50">
      <div class="soft-card p-8 text-center space-y-4 max-w-sm w-full">
        <div id="result-icon"></div>
        <h2 id="result-title" class="text-3xl font-bold"></h2>
        <p id="result-message" class="text-gray-700 whitespace-pre-line"></p>
        <p id="result-score" class="text-xl font-bold"></p>
        <button id="restartBtn" class="w-full btn-pink font-bold py-3 rounded-xl" type="button">ëŸ°ì²˜ë¡œ ëŒì•„ê°€ê¸°</button>
      </div>
    </div>
  </div>
</section> 
  <!-- ì½”ë“œíœ JS íŒ¨ë„ ë‚´ìš© -->
  <script>
    'use strict';
    
// ===== ì „ì—­ íš¨ê³¼ìŒ ì„ ì–¸ =====
const sfxClick = new Audio('sounds/click.mp3');
sfxClick.preload = 'auto';
    
/* ========== ì „ì—­ ìƒíƒœ/DOM (initì—ì„œ ì—°ê²°) ========== */
const MBTIS = ["ENFP","ENFJ","ENTP","ENTJ","ESFP","ESFJ","ESTP","ESTJ","INFP","INFJ","INTP","INTJ","ISFP","ISFJ","ISTP","ISTJ"];
let targetMbti = null; 
let score = 100, currentRound = 0, strikes = 0, gameActive = true; 
const maxStrikes = 3; 
let chosenMbti = []; 
let sparkStreak = 0, lastTag = null, keyBuff = false;

// DOM refs (initì—ì„œ ì„¸íŒ…)
let launcher,row1,row2,randomBtn,gameRoot,backBtn,restartBtn,targetChip,dialogueArea,optionsArea,scoreText,scoreBarInner,resultModal,strikeBadge,progressText,effectsLayer,finalLayer,toast,replyPop;

/* ========== ëŸ°ì²˜ ========== */
function addBtn(type, row){
  const b = document.createElement('button');
  b.type = 'button';
  b.className = 'w-full bg-white border border-pink-200 rounded-xl py-3 px-2 hover:border-pink-400 hover:bg-pink-50 text-[#c24373] font-bold';
  b.textContent = 'ğŸ’Œ ' + type;
  b.onclick = () => selectTarget(type);
  row.appendChild(b);
}
function buildLauncher(){
  if(row1 && !row1.childElementCount) MBTIS.slice(0,8).forEach(t=>addBtn(t,row1));
  if(row2 && !row2.childElementCount) MBTIS.slice(8).forEach(t=>addBtn(t,row2));
  if(randomBtn && !randomBtn.__bound){ 
    randomBtn.onclick = () => selectTarget(MBTIS[Math.floor(Math.random()*MBTIS.length)]);
    randomBtn.__bound = true;
  }
}
function selectTarget(type){
  targetMbti = type;
  targetChip.innerHTML = `ìƒëŒ€ MBTI: <b>${type}</b>`;
  resetAll();
  launcher.classList.add('hidden');
  gameRoot.classList.remove('hidden');

  // ì˜¤ë””ì˜¤ í•´ì œ ì•ˆì „ë§(í•œ ë²ˆë§Œ)
  if(!AudioKit.unlocked){
    try { AudioKit.resume(); AudioKit.prime(); } catch(_) {}
  }

  startGame();
}

/* ========== ì§ˆë¬¸/ì˜µì…˜(ìš”ì•½) ========== */
const QUESTIONS = {
  ENFP:["ì•ˆë…•! ì˜¤ëŠ˜ ëŠë‚Œ ì¢‹ì•„ìš”. ìš”ì¦˜ ê°‘ìê¸° ê½‚íŒ ê±° ìˆì–´ìš”?","ì–´ìƒ‰í•¨ ê¹¨ëŠ” ë‹¹ì‹ ë§Œì˜ ê¿€íŒ ìˆì–´ìš”?","ì½”ìŠ¤ëŠ” ë°˜ ê³„íš ë°˜ ì¦‰í¥, ì–´ë•Œìš”?","ì§€ê¸ˆ ë¶„ìœ„ê¸°ì— ì–´ìš¸ë¦¬ëŠ” ë…¸ë˜ëŠ”ìš”?","ì˜¤ëŠ˜ í•œ ì¤„ë¡œ ì •ë¦¬í•˜ìë©´ìš”?"],
  ENFJ:["ë°˜ê°€ì›Œìš”! í…ì…˜ ë§ì¶”ë ¤ë©´ ì œê°€ ë­˜ í•˜ë©´ ì¢‹ì„ê¹Œìš”?","ë§ˆìŒì„ ì—¬ëŠ” ì§ˆë¬¸, ì–´ë–¤ ê²Œ ì˜ ë§ì•„ìš”?","ë¦¬ë“œ vs ì¡°ìœ¨, ì˜¤ëŠ˜ì€ ë­ê°€ í¸í•´ìš”?","ëŒ€í™”ì— ì˜¨ê¸° ì˜¬ë¦¬ëŠ” ìŒì•… ì·¨í–¥ì€ìš”?","ì˜¤ëŠ˜ í•¨ê»˜í•´ì„œ ì¢‹ì•˜ë˜ í¬ì¸íŠ¸ í•œ ì¤„?"],
  ENTP:["ë°”ë¡œ í•œ íŒ ë¶™ì–´ë³¼ê¹Œìš”? ìµœê·¼ì— ìƒê° ë°”ë€ ì£¼ì œ ìˆì–´ìš”?","ì§€ê¸ˆ ì‘ì€ ì‹¤í—˜ í•œë‹¤ë©´ ë­˜ í•´ë³¼ë˜ìš”?","ë£° ì„¸ìš°ê³  ê¹¨ê¸° vs ë°”ë¡œ í”¼ë²—, ì˜¤ëŠ˜ì€?","ì•„ì´ë””ì–´ ìŠ¤íŒŒí¬ ì˜¬ë¼ì˜¤ëŠ” ì‚¬ìš´ë“œëŠ”ìš”?","ì˜¤ëŠ˜ ì¸ì‚¬ì´íŠ¸ë¥¼ í•œ ì¤„ íŠ¸ìœ—ìœ¼ë¡œ?"],
  ENTJ:["ì‹œê°„ ì•„ë‚ì‹œë‹¤. ì˜¤ëŠ˜ ë”± í•˜ë‚˜ ëª©í‘œ ì¡ëŠ”ë‹¤ë©´ìš”?","ì´ˆë°˜ 10ë¶„, ë¶„ìœ„ê¸° ì¥ì•… í”Œëœì€ìš”?","ë¹ ë¥¸ ê²°ì • vs ì—¬ìœ  íƒìƒ‰, ì–´ë””ì— íˆ¬ìí•´ìš”?","ì§‘ì¤‘ ì˜¬ë¼ê°€ëŠ” ìŒì•… íƒ€ì…ì€ìš”?","ì˜¤ëŠ˜ì˜ ì„±ê³¼ë¥¼ í•œ ë¬¸ì¥ìœ¼ë¡œìš”?"],
  ESFP:["ë¶„ìœ„ê¸° ì¢‹ë‹¤! ì§€ê¸ˆ ë‹¹ì¥ ì¬ë°ŒëŠ” ê±° ë­ ë³´ì—¬ìš”?","ì–¼ìŒ ê¹¨ëŠ” ì²« ë©˜íŠ¸, ë³¸íˆ¬ë¹„ ìˆì£ ?","ê±·ë‹¤ê°€ ëŒë¦¬ë©´ ë°”ë¡œ ë©ˆì¶”ê¸°, ê´œì°®ì£ ?","ëª¸ì´ ë¨¼ì € ë°˜ì‘í•˜ëŠ” ë…¸ë˜ í•˜ë‚˜!","ì˜¤ëŠ˜ ë² ìŠ¤íŠ¸ ì»· ìë§‰ ë­ë¡œ í• ê¹Œìš”?"],
  ESFJ:["ìë¦¬ í¸í•˜ì£ ? ë” í¸í•´ì§€ê²Œ ì œê°€ ë­˜ í•˜ë©´ ì¢‹ì„ê¹Œìš”?","ì²« ë§Œë‚¨ì—ì„œ ë”°ëœ»í•´ì§€ëŠ” í¬ì¸íŠ¸, ë­ê°€ ìˆë‚˜ìš”?","ë‘˜ ë‹¤ ë¬´ë¦¬ ì—†ëŠ” íƒ€ì´ë°ìœ¼ë¡œ ì½”ìŠ¤ ë§ì¶œê¹Œìš”?","ëŒ€í™”ì— ì˜ ê¹”ë¦¬ëŠ” ë°°ê²½ìŒ ì·¨í–¥ì€ìš”?","ì˜¤ëŠ˜ì˜ ê°ì‚¬ í•œ ì¤„, ë‚¨ê²¨ë³¼ê¹Œìš”?"],
  ESTP:["ì•¡ì…˜ìœ¼ë¡œ ê°€ì£ . ê·¼ì²˜ì— ì‘ì€ ëª¨í—˜ í•˜ë‚˜?","ì–´ìƒ‰í•¨ ë¹¨ë¦¬ í‘¸ëŠ” ì¹˜íŠ¸í‚¤ ë­ ì¨ìš”?","íš¨ìœ¨ vs ìš°ì—° ë£¨íŠ¸, ì˜¤ëŠ˜ì€ ì–´ë””ì— ë² íŒ…?","ì•„ë“œë ˆë‚ ë¦° ì˜¬ë¼ê°€ëŠ” ì²« íŠ¸ë™ì€ìš”?","ì˜¤ëŠ˜ í•˜ì´ë¼ì´íŠ¸, ì§§ê²Œ ì½œì•„ì›ƒ!"],
  ESTJ:["ì¢‹ì€ ë§Œë‚¨, ê·œì¹™ í•˜ë‚˜ë¶€í„° í•©ì˜í• ê¹Œìš”?","ì„œë¡œ ì‹œê°„ ì•„ë¼ëŠ” ëŒ€í™” ìš´ì˜ ë°©ì‹ì€ìš”?","ì •ì‹œ ì´ë™ vs ì—¬ìœ  íƒìƒ‰, ì˜¤ëŠ˜ì€ìš”?","ì§‘ì¤‘ ê¹¨ì§€ì§€ ì•ŠëŠ” ìŒì•…ì´ë©´ ì¢‹ê² ì£ ?","ì˜¤ëŠ˜ íšŒê³ ë¥¼ ê²°ë¡  ì¤‘ì‹¬ìœ¼ë¡œìš”."],
  INFP:["ì‚´ì§ ì¡°ì‹¬ìŠ¤ëŸ½ê²Œ. ìš”ì¦˜ ë§ˆìŒ ê±´ë“œë¦° ë¬¸ì¥ ìˆì–´ìš”?","ì²˜ìŒ ë§Œë‚¨ì—ì„œ ì•ˆì „í•¨ì„ ì£¼ëŠ” ë°©ë²•ì€ìš”?","ê±·ë‹¤ê°€ ì‘ì€ ì–˜ê¸° ì£¼ì›Œ ë‹´ëŠ” ë£¨íŠ¸, ì–´ë•Œìš”?","ê°€ì‚¬ ì˜ˆìœ ë…¸ë˜ í•˜ë‚˜ ë“¤ì–´ìš”?","ì˜¤ëŠ˜ì˜ ê°ì •, ì‹œì²˜ëŸ¼ í•œ ì¤„ë¡œìš”."],
  INFJ:["ì°¨ë¶„í•˜ê²Œ ì‹œì‘í•´ìš”. ìµœê·¼ ê¹Šê²Œ ìƒê°í•œ ì£¼ì œëŠ”ìš”?","ëŒ€í™”ì˜ ê¹Šì´ë¥¼ ì—¬ëŠ” ì§ˆë¬¸, ë­ê°€ ì˜ ë§ì•„ìš”?","ì˜ë¯¸ ë‚¨ëŠ” ë™ì„ , ì–´ë–»ê²Œ ì„¤ê³„í•˜ë©´ ì¢‹ì„ê¹Œìš”?","ìƒê° ì •ë¦¬ë˜ëŠ” ìŒì•… ê²°ì€ìš”?","ì˜¤ëŠ˜ì˜ ìš”ì§€, í•œ ë¬¸ì¥ í†µì°°ë¡œìš”."],
  INTP:["í˜¸ê¸°ì‹¬ ì²´í¬ë¶€í„°. ìš”ì¦˜ íŒŒëŠ” ì§ˆë¬¸ì€ìš”?","ì²« ë§Œë‚¨ì— ì‹œí—˜í•´ë³´ê³  ì‹¶ì€ ëŒ€í™” í¬ë§· ìˆì–´ìš”?","ê²½ë¡œ ìµœì í™” vs ì‹¤í—˜ ìš°íšŒ, ë­ê°€ ì¬ë°Œì–´ìš”?","ë°©í•´ ì•ˆ ë˜ëŠ” ë°±ê·¸ë¼ìš´ë“œ ìŠ¤í™ì€ìš”?","ì˜¤ëŠ˜ ê°€ì„¤ê³¼ ê²°ë¡ , ìš”ì•½í•˜ë©´ìš”?"],
  INTJ:["ëŒë ¤ ë§ ì•ˆ í•´ìš”. ì˜¤ëŠ˜ ì˜ë„ í•œ ë¬¸ì¥ìœ¼ë¡œìš”?","ì²«ì¸ìƒì—ì„œ í™•ì¸í•˜ê³  ì‹¶ì€ ë³€ìˆ˜ í•˜ë‚˜?","ëª©í‘œ ì§€í–¥ vs ì—¬ìœ  íƒìƒ‰, ì–´ë””ì— íˆ¬ìí•˜ì£ ?","ì‚¬ê³  íš¨ìœ¨ ì˜¬ë¦¬ëŠ” ìŒì› íƒ€ì…ì€ìš”?","ì˜¤ëŠ˜ ì¸ì‚¬ì´íŠ¸, ì„ ì–¸ë¬¸ì²˜ëŸ¼ ì •ë¦¬!"],
  ISFP:["ëŠë‚Œ ì¢‹ì€ ì¶œë°œ. ì§€ê¸ˆ ì´ ìˆœê°„ ì¢‹ì•„ì§€ëŠ” ìš”ì†Œ í•˜ë‚˜?","í¸ì•ˆí•¨ ì—¬ëŠ” ì²« ë©˜íŠ¸, ë‹¹ì‹  í†¤ì€ìš”?","í’ê²½ ì¢‹ì€ ê¸¸ë¡œ ì‚´ì§ ëŒì•„ê°€ë„ ê´œì°®ì£ ?","ì”ì”í•˜ê³  ìƒ‰ê° ì˜ˆìœ ê³¡ í•˜ë‚˜ ê³¨ë¼ìš”.","ì˜¤ëŠ˜ì˜ ì˜¨ë„, í•œ ì¤„ ê¸°ë¡í•´ìš”."],
  ISFJ:["í¸ì•ˆí•˜ë„¤ìš”. ì¼ì£¼ì¼ ì•ˆì •ì‹œí‚¤ëŠ” ë£¨í‹´ í•˜ë‚˜ ê³µìœ í•´ìš”.","ì²˜ìŒì— ê°€ì¥ í˜ì´ ë˜ëŠ” ë°°ë ¤ëŠ” ë­ì˜€ë‚˜ìš”?","ë¶€ë‹´ ì—†ê³  ì°¨ë¶„í•œ ë£¨íŠ¸ë¡œ ì‹œì‘í•´ë³¼ê¹Œìš”?","ëŒ€í™” ë°©í•´ë˜ì§€ ì•ŠëŠ” ì”ì”í•œ ìŒì•…ì€ìš”?","ì˜¤ëŠ˜ì˜ ê³ ë§ˆì›€, ì§§ê²Œ í•œ ì¤„ë¡œìš”."],
  ISTP:["ì‹¤ìš©ì ìœ¼ë¡œ ê°€ìš”. ìµœê·¼ ì§ì ‘ ê³ ì¹œ ê±° ìˆì–´ìš”?","ì–´ìƒ‰í•¨ ì¤„ì´ëŠ” ë¹ ë¥¸ ì…‹ì—…ì€ìš”?","ëŒë°œì—ë„ ëŒ€ì‘ ê°€ëŠ¥í•œ ë™ì„ , ì–´ë–¤ê°€ìš”?","ê¸°ë¶„ ì •ëˆë˜ëŠ” ë¯¸ë‹ˆë©€ íŠ¸ë™ ì¶”ì²œ ìˆì–´ìš”?","ì˜¤ëŠ˜ í•µì‹¬ë§Œ ê±´ì¡°í•˜ê²Œ í•œ ì¤„!"],
  ISTJ:["ë¨¼ì € ì²´í¬ë¶€í„°. ì˜¤ëŠ˜ ì¼ì • ì—¬ìœ ëŠ”ìš”?","ì²« ëŒ€í™”ì˜ ìˆœì„œì™€ ê·œì¹™, ê°„ë‹¨íˆ ì¡ì„ê¹Œìš”?","ì‹œê°„ ë§ì¶° ì´ë™ ë£¨íŠ¸, ì‹œì‘í•´ë³¼ê¹Œìš”?","ì§‘ì¤‘ ííŠ¸ëŸ¬ì§€ì§€ ì•ŠëŠ” ìŒì•…ì´ì£ ?","ì˜¤ëŠ˜ íšŒê³ , ê°„ë‹¨ ëª…ë£Œí•˜ê²Œìš”."]
};

/* í˜ë¥´ì†Œë‚˜ë³„ ì˜µì…˜ */
const PERSONA_OPTIONS = { /* ê·¸ëŒ€ë¡œ: ê¸´ ë¸”ë¡ì´ë¯€ë¡œ ìƒëµ í‘œì‹œ ì—†ì´ ì „ì²´ ìœ ì§€í•˜ì„¸ìš”. 
   ë„¤ê°€ ë¶™ì—¬ ì¤€ ENFP~ISTJ ì˜µì…˜ ë°°ì—´ ì „ë¶€ í¬í•¨ (ì—¬ê¸°ì„œëŠ” ì§€ë©´ìƒ ìƒëµ) */
  ENFP:[ /* ... ë„¤ê°€ ì¤€ ë°°ì—´ ê·¸ëŒ€ë¡œ ... */ ],
  ENFJ:[ /* ... */ ],
  ENTP:[ /* ... */ ],
  ENTJ:[ /* ... */ ],
  ESFP:[ /* ... */ ],
  ESFJ:[ /* ... */ ],
  ESTP:[ /* ... */ ],
  ESTJ:[ /* ... */ ],
  INFP:[ /* ... */ ],
  INFJ:[ /* ... */ ],
  INTP:[ /* ... */ ],
  INTJ:[ /* ... */ ],
  ISFP:[ /* ... */ ],
  ISFJ:[ /* ... */ ],
  ISTP:[ /* ... */ ],
  ISTJ:[ /* ... */ ]
};

/* ê³µìš© í…œí”Œë¦¿(í´ë°±) â€” ê¸°ì¡´ê³¼ ë™ì¼ */
const OPTION_TEMPLATES = {
  spark:['ì§€ë„ ì ‘ê³  ê·¸ëƒ¥ ê±¸ì–´ìš”. ëŒë¦¬ë©´ ë°”ë¡œ ë“¤ì–´ê°€ìš”.','ë¯¸ì…˜ êµí™˜ ì–´ë•Œìš”? ì„œë¡œ í•˜ë‚˜ ì£¼ê³  10ë¶„ ë’¤ ê³µìœ !','ì™¼ìª½ë§Œ ë³´ê¸° ë£°ë¡œ ê°€ë‹¤ ëŒë¦¬ë©´ ë©ˆì¶”ê¸°.','í›…ì—ì„œ í„°ì§€ëŠ” ë…¸ë˜ í•˜ë‚˜ ê³¨ë¼ìš”.','ì¢‹ìœ¼ë©´ ì§€ê¸ˆ 5ë¶„ë§Œ ì¨ì„œ ë‹¤ìŒ ì•½ì† ì¡ì£ .'],
  safe: ['ê³µí†µ ê´€ì‹¬ì‚¬ í•œ ê°€ì§€ë¡œ 5ë¶„ ì§‘ì¤‘ ëŒ€í™”.','ë‘ êµ°ë°ë§Œ ì •í•˜ê³  ë‚˜ë¨¸ì§„ ê°€ë©´ì„œ ê²°ì •.','í•µì‹¬ í•œ ê³³ ì˜ˆì•½í•˜ê³  ë‚˜ë¨¸ì§„ í˜„ì¥ ì„ íƒ.','ê°€ì‚¬ë³´ë‹¤ ë¦¬ë“¬ ì¢‹ì€ ì‹œí‹°íŒ.','ì—…ë‹¤ìš´ ìˆì—ˆëŠ”ë° ê·¸ë˜ì„œ ê¸°ì–µì— ë‚¨ì•„ìš”.'],
  trap: ['ê³„íší‘œëŒ€ë¡œ ì°©ì°©. ë³€ìˆ˜ ìµœì†Œ.','ì§ˆë¬¸ ë¦¬ìŠ¤íŠ¸ë¥¼ ìˆœì„œëŒ€ë¡œ ì§„í–‰.','ì‹œê°„í‘œëŒ€ë¡œ ì™„ì£¼. ë™ì„ ë‚­ë¹„ ì œë¡œ.','ì°¨íŠ¸ 1ìœ„ë¡œ ë¬´ë‚œí•˜ê²Œ ê°€ìš”.','ë¬´ë‚œí–ˆì–´ìš”.']
};

/* ì²« ì¸ì‚¬ */
const GREETINGS = {
  ENFP: "ì˜¤! ì˜¤ëŠ˜ ë¶„ìœ„ê¸° ì¢‹ë„¤ìš”. ê°€ë²¼ìš´ ë†ë‹´ ëª‡ ê°œ ì¤€ë¹„í•´ì™”ëŠ”ë°, ë“¤ì–´ë³¼ë˜ìš”?",
  ENFJ: "ì™€ì£¼ì…”ì„œ ë°˜ê°€ì›Œìš”. í¸í•˜ê²Œ ë§ì”€í•´ ì£¼ì„¸ìš”, ë¶„ìœ„ê¸°ëŠ” ì œê°€ ë¶€ë“œëŸ½ê²Œ ë§Œë“¤ê²Œìš”.",
  ENTP: "ì €ëŠ” ìƒˆë¡œìš´ ìƒí™©ì—ì„œ ë£°ì„ ê¹¨ëŠ” ê±¸ ì¦ê²¨ìš”. ì˜¤ëŠ˜ë„ ì•„ë§ˆ ê·¸ëŸ´ ë“¯?",
  ENTJ: "ë°˜ê°‘ìŠµë‹ˆë‹¤. ì˜¤ëŠ˜ì€ ì„œë¡œ ì‹œê°„ ê°’ì§€ê²Œ ì¨ë´…ì‹œë‹¤. ëª©í‘œëŠ” â€˜ì¬ë°ŒëŠ” í•˜ë£¨â€™ ì–´ë•Œìš”?",
  ESFP: "ì˜¤ëŠ˜ì€ ê¸°ë¶„ì´ ì—…ì´ì—ìš”! ëˆˆì— ë„ëŠ” ê±° ìˆìœ¼ë©´ ë°”ë¡œ ê°€ë³¼ê¹Œìš”?",
  ESFJ: "ìë¦¬ í¸í•˜ì£ ? ì €ëŠ” ì±™ê²¨ì£¼ëŠ” ê±° ìì‹  ìˆì–´ì„œ, ê±±ì • ì—†ì´ ì¦ê¸°ì‹œë©´ ë¼ìš”.",
  ESTP: "ì•‰ì•„ì„œ ì–˜ê¸°í•˜ëŠ” ê²ƒë„ ì¢‹ì§€ë§Œ, ë°”ë¡œ ë­”ê°€ í•´ë³´ëŠ” ê±´ ì–´ë–¨ê¹Œìš”?",
  ESTJ: "ë§Œë‚¨ë„ ì „ëµì´ í•„ìš”í•˜ì£ . ê°„ë‹¨í•œ ê³„íš í•˜ë‚˜ ì„¸ìš°ê³  ì‹œì‘í• ê¹Œìš”?",
  INFP: "ì„œë‘ë¥´ì§€ ì•Šì•„ë„ ë¼ìš”. ì˜¤ëŠ˜ì€ ì„œë¡œì˜ ì´ì•¼ê¸°ì— ì¡°ê¸ˆì”© ë¬¼ë“¤ì–´ê°€ëŠ” ê±¸ë¡œ í•´ìš”.",
  INFJ: "ì²˜ìŒì´ë¼ ì¡°ê¸ˆ ì¡°ìš©í•  ìˆ˜ ìˆì§€ë§Œ, ê³§ ê¹Šì€ ì–˜ê¸° ë‚˜ì˜¬ ê±°ì˜ˆìš”.",
  INTP: "ì €, ê¶ê¸ˆí•œ ê²Œ ë§ì•„ìš”. ì‹¤í—˜í•˜ë“¯ ëŒ€í™”í•˜ë©´ ì¬ë°Œì„ ê²ƒ ê°™ì•„ìš”.",
  INTJ: "ì¢‹ì•„ìš”, ì„œë¡œ ì›í•˜ëŠ” ê²Œ ë­”ì§€ ë°”ë¡œ ë§ì¶°ê°€ì£ . ê·¸ê²Œ í¸í•˜ì–ì•„ìš”.",
  ISFP: "ì˜¤ëŠ˜ì€ ë°œê¸¸ ë‹¿ëŠ” ëŒ€ë¡œ ê°€ë³¼ë˜ìš”? ëŠë‚Œì´ ì¢‹ì€ ë‚ ì´ê±°ë“ ìš”.",
  ISFJ: "í¸ì•ˆí•˜ê²Œ ì‹œì‘í•˜ì£ . ë¶€ë‹´ ì—†ì´ ì„œë¡œ ì•Œì•„ê°€ë©´ ì¢‹ê² ì–´ìš”.",
  ISTP: "ë°”ë¡œ ì²´í—˜í•´ë³´ëŠ” ê²Œ ì œ ìŠ¤íƒ€ì¼ì´ì—ìš”. ë§ë³´ë‹¨ í•´ë³´ëŠ” ê±¸ë¡œ.",
  ISTJ: "ê¸°ë³¸ë¶€í„° ì°¨ê·¼ì°¨ê·¼, ì„œë‘ë¥´ì§€ ì•Šê³  ê°€ëŠ” ê²Œ ì¢‹ì£ ."
};

/* ë°ì´í„° ë¹Œë“œ */
function buildGameData(type){
  const qs = QUESTIONS[type] || QUESTIONS.ENFP;
  const persona = PERSONA_OPTIONS[type];
  const scorePos=[18,16,14,16,20], scoreNeg=[-12,-12,-12,-10,-12];
  if(persona){
    return qs.map((q,i)=>{
      const opts = persona[i].map((o)=>({
        tag:o.tag, text:o.text, reply:o.reply,
        score: o.tag==='spark'?scorePos[i]: o.tag==='trap'?scoreNeg[i]: 6,
        grantsKey: i===0 && o.tag==='spark'
      }));
      return { q, opts };
    });
  }
  return qs.map((q,i)=>({ q, opts:[
    {tag:'spark',score:scorePos[i],text:OPTION_TEMPLATES.spark[i],reply:'ì¢‹ì•„ìš”!',grantsKey:i===0},
    {tag:'safe', score:6,text:OPTION_TEMPLATES.safe[i],reply:'ë¬´ë‚œí•˜ë„¤ìš”.'},
    {tag:'trap', score:scoreNeg[i],text:OPTION_TEMPLATES.trap[i],reply:'ì¡°ê¸ˆ ë”±ë”±í•´ìš”.'}
  ] }));
}

/* ê³µìš© ìœ í‹¸ */
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
function addDialogue(text, isPlayer=false){
  while(dialogueArea.childElementCount > 1){ dialogueArea.removeChild(dialogueArea.firstElementChild); }
  const row=document.createElement('div'); row.className='w-full flex';
  const bubble=document.createElement('div'); bubble.textContent=text; bubble.className='dialogue-bubble';
  if(isPlayer){ row.classList.add('justify-end'); bubble.style.background='var(--pink-500)'; bubble.style.color='#fff'; bubble.style.border='none'; bubble.style.borderBottomRightRadius='.35rem'; }
  else { row.classList.add('justify-start'); bubble.style.background='#ffffff'; bubble.style.color='#1f2937'; bubble.style.border='1px solid #f3e5ea'; bubble.style.borderBottomLeftRadius='.35rem'; }
  row.appendChild(bubble); dialogueArea.appendChild(row); dialogueArea.scrollTop=dialogueArea.scrollHeight;
}
function updateMeters(){ score=Math.max(0,Math.min(200,score)); scoreText.textContent=`${score} / 200`; scoreBarInner.style.width=`${score/2}%`; strikeBadge.textContent=`${strikes} / ${maxStrikes}`; progressText.textContent=`${Math.min(currentRound+1,gameData.length)} / ${gameData.length}`; }
function renderRound(idx){
  optionsArea.innerHTML=''; const round=gameData[idx];
  setTimeout(()=>{ 
    addDialogue(round.q); 
    shuffle([...round.opts]).forEach(opt=>{
      const btn=document.createElement('button'); 
      btn.textContent=opt.text; 
      const tagStyle = opt.tag==='spark' ? 'bg-pink-50 border-pink-300 hover:bg-pink-100 text-[#b4235b]' : opt.tag==='safe' ? 'bg-amber-50 border-amber-300 hover:bg-amber-100 text-[#7a4b00]' : 'bg-gray-50 border-gray-300 hover:bg-gray-100 text-gray-700'; 
      btn.className = `w-full text-left p-4 rounded-xl font-medium border ${tagStyle}`; 
      btn.onclick=()=>handleOption(opt); 
      optionsArea.appendChild(btn); 
    }); 
  },200);
}

/* ì‚¬ìš´ë“œ/í† ìŠ¤íŠ¸/íŒŒí‹°í´ */
const AudioKit = (()=>{ 
  const ctx = new (window.AudioContext||window.webkitAudioContext)(); let unlocked=false; 
  function resume(){ if(ctx.state!=='running'){ ctx.resume(); } unlocked=true; } 
  function env(node,{a=0.003,d=0.22,s=0.0001,r=0.12,peak=0.7}={}){ const t=ctx.currentTime; node.gain.cancelScheduledValues(t); node.gain.setValueAtTime(0.0001,t); node.gain.linearRampToValueAtTime(peak,t+a); node.gain.exponentialRampToValueAtTime(Math.max(0.0001,peak*s),t+a+d); node.gain.setTargetAtTime(0.0001,t+a+d,r);} 
  function mallet({freq=880,dur=0.28}={}){ const g=ctx.createGain(); env(g,{}); const bp=ctx.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value=freq*2; bp.Q.value=6; const lpf=ctx.createBiquadFilter(); lpf.type='lowpass'; lpf.frequency.value=4200; lpf.Q.value=.7; const o1=ctx.createOscillator(); o1.type='sine'; o1.frequency.value=freq; const o2=ctx.createOscillator(); o2.type='triangle'; o2.frequency.value=freq*2.66; const o3=ctx.createOscillator(); o3.type='sine'; o3.frequency.value=freq*3.98; o1.connect(g); o2.connect(g); o3.connect(g); g.connect(bp); bp.connect(lpf); lpf.connect(ctx.destination); const now=ctx.currentTime; [o1,o2,o3].forEach(o=>{o.start(now); o.stop(now+dur);}); return new Promise(r=>o3.onended=r);} 
  async function xylophoneSuccess(){ const base=880; await mallet({freq:base}); await mallet({freq:base*1.333}); await mallet({freq:base*1.781}); } 
  async function meh(){ await mallet({freq:523,dur:.2}); } 
  async function fail(){ await mallet({freq:220,dur:.3}); await mallet({freq:175,dur:.32}); } 
  function prime(){ 
    const g = ctx.createGain(); g.gain.value = 0.0001; 
    const o = ctx.createOscillator(); o.type = 'sine'; o.frequency.value = 440; 
    o.connect(g); g.connect(ctx.destination); 
    const now = ctx.currentTime; o.start(now); o.stop(now + 0.05); 
  }
  return { resume, xylophoneSuccess, meh, fail, prime, get unlocked(){return unlocked;} };
})();
// ëª¨ë°”ì¼ ì˜¤ë””ì˜¤ í•´ì œ: ì²« ì œìŠ¤ì²˜(click/touch/pointer)ì—ì„œ í•œ ë²ˆë§Œ ìˆ˜í–‰
function bindAudioUnlock(){
  let done = false;
  const tryUnlock = () => {
    if (done) return;
    done = true;
    try {
      AudioKit.resume();
      AudioKit.prime();
      showToast('ì‚¬ìš´ë“œ ì˜¨','ok');
    } catch(e) { /* noop */ }
    ['touchstart','pointerdown','click'].forEach(t=>{
      document.removeEventListener(t, tryUnlock, true);
    });
  };
  ['touchstart','pointerdown','click'].forEach(t=>{
    document.addEventListener(t, tryUnlock, true);
  });
}
document.addEventListener('DOMContentLoaded', bindAudioUnlock);

const ICONS = { heart:`<svg viewBox="0 0 24 24" fill="#ef4444" xmlns="http://www.w3.org/2000/svg"><path d="M12 21s-6.716-4.297-9.192-7.23C.69 11.36 1.127 7.9 3.757 6.33A5.2 5.2 0 0 1 12 7.2a5.2 5.2 0 0 1 8.243-.87c2.63 1.57 3.066 5.03.95 7.44C18.716 16.703 12 21 12 21z"/></svg>`, spark:`<svg viewBox="0 0 24 24" fill="#f59e0b" xmlns="http://www.w3.org/2000/svg"><path d="M12 2l2.2 5.8L20 10l-5.8 2.2L12 18l-2.2-5.8L4 10l5.8-2.2L12 2z"/></svg>`, broken:`<svg viewBox="0 0 24 24" fill="#9ca3af" xmlns="http://www.w3.org/2000/svg"><path d="M12 21s-6.716-4.297-9.192-7.23C.69 11.36 1.127 7.9 3.757 6.33c1.29-.77 2.77-.93 4.12-.54L10 9l-2 3 3 2-1 3 2 1 2-4-3-2 1-3 2-2a5.2 5.2 0 0 1 3.12.06c2.63 1.57 3.066 5.03.95 7.44C18.716 16.703 12 21 12 21z"/></svg>`, shard:`<svg viewBox="0 0 24 24" fill="#6b7280" xmlns="http://www.w3.org/2000/svg"><path d="M4 14l6-10 4 6-6 10-4-6z"/></svg>` };

/* ========== ê·œì¹™/íë¦„ ========== */
function isFType(type){ return type && type[2] === 'F'; }

function decorateReplyForType(type, base, tag){
  if(!isFType(type)) return base;
  if(tag === 'spark') return `${base} ì„¤ë ˆìš”, ì§€ê¸ˆ ì´ ëŠë‚Œ ê³„ì† ê°€ìš”`;
  if(tag === 'safe')  return `${base} í¸ì•ˆí•´ì„œ ì¢‹ì•„ìš”`;
  if(tag === 'trap')  return `${base} ìŒâ€¦ ì¡°ê¸ˆ ì•„ì‰¬ì› ì–´ìš”. ë‹¤ìŒì€ ìš°ë¦¬ í…œí¬ë¡œ ê°€ìš”.`;
  return base;
}

function applyHidden(opt){
  if(opt.tag === 'spark'){
    sparkStreak += 1;
    if(sparkStreak >= 2){
      addScore(6);
      showToast('ì½¤ë³´ ë³´ë„ˆìŠ¤ +6','ok');
    }
  } else {
    sparkStreak = 0;
  }

  if(opt.grantsKey){
    keyBuff = true;
  } else if(keyBuff && opt.tag === 'spark'){
    addScore(4);
    keyBuff = false;
    showToast('í‚¤ ì‹œë„ˆì§€ +4','ok');
  }

  if(lastTag === 'trap' && opt.tag === 'trap'){
    strikes += 1;
    addScore(-4);
    showToast('ì—°ì† ì‹¤ìˆ˜ -4','bad');
  }

  lastTag = opt.tag;
}

function charmDelta(opt){
  const isFinal = currentRound === gameData.length - 1;
  if(isFinal) return;

  if(opt.tag === 'spark'){
    showToast('ë§¤ë ¥ì´ ìƒìŠ¹í–ˆë‹¤','ok');
    try{ AudioKit.xylophoneSuccess(); }catch(_e){}
  } else if(opt.tag === 'trap'){
    showToast('ë§¤ë ¥ì´ ê°ì†Œí–ˆë‹¤','bad');
    try{ AudioKit.fail(); }catch(_e){}
  } else {
    showToast('ë§¤ë ¥ì´ ìœ ì§€ëë‹¤','meh');
    try{ AudioKit.meh(); }catch(_e){}
  }
}

function handleOption(opt){
  // ëª¨ë°”ì¼ ì²« í´ë¦­ ì‹œ: ì˜¤ë””ì˜¤ ì»¨í…ìŠ¤íŠ¸ í•´ì œ + ì‹¤ì œ ì†Œë¦¬ 1íšŒ ì¬ìƒ (íŒŒì¼ ì‹¤íŒ¨ ì‹œ WebAudioë¡œ ëŒ€ì²´)
  if(!AudioKit.unlocked){
    try {
      AudioKit.resume();
      AudioKit.prime();
      sfxClick.currentTime = 0;
      sfxClick.play().catch(()=>AudioKit.meh());
    } catch(_e){}
  }

  if(!gameActive) return;

  addDialogue(opt.text, true);
  optionsArea.innerHTML = '<div class="text-center text-gray-500 animate-pulse">ë‹µë³€ ì¤‘â€¦</div>';

  setTimeout(()=>{
    addScore(opt.score);
    if(opt.tag === 'trap') strikes += 1;
    chosenMbti.push(targetMbti);
    applyHidden(opt);
    updateMeters();
    charmDelta(opt);

    const replyText = decorateReplyForType(targetMbti, opt.reply, opt.tag);
    showReply(replyText);

    currentRound++;
    const out = currentRound >= gameData.length;
    const tooMany = strikes >= maxStrikes;

    if(out || tooMany){
      endGame(score, tooMany && !out);
    } else {
      renderRound(currentRound);
    }
  }, 650);
}

function endGame(finalScore, dueToStrikes=false){
  gameActive = false;
  if (replyPop) replyPop.innerHTML = '';

  const t = document.getElementById('result-title');
  const m = document.getElementById('result-message');
  const s = document.getElementById('result-score');
  const iconEl = document.getElementById('result-icon');

  let tier = 'fail';
  if(finalScore >= 165) tier = 'great';
  else if(finalScore >= 125) tier = 'good';
  else if(finalScore >= 95)  tier = 'meh';

  t.textContent = (tier==='great')? 'ì• í”„í„° ëŒ€ì„±ê³µ'
                : (tier==='good') ? 'ì• í”„í„° ì‹ ì²­ ê°'
                : (tier==='meh')  ? 'ì—¬ì§€ ìˆìŒ'
                : 'ìƒëŒ€ë°©ì´ ë‚  ì°¨ë‹¨í–ˆì–´ìš”.';

  if(iconEl){
    iconEl.textContent = (tier==='fail') ? 'ğŸ’”' : (tier==='meh') ? 'ğŸ™‚' : 'ğŸ’–';
    iconEl.style.fontSize = '44px';
  }

  if(tier !== 'fail'){
    triggerFinalFX(tier);
  }

  const mbtiCount = chosenMbti.reduce((acc,t)=>{ acc[t]=(acc[t]||0)+1; return acc; },{});
  const topMbti = Object.entries(mbtiCount).sort((a,b)=>b[1]-a[1])[0]?.[0];

  let line = '';
  if(topMbti){
    if(tier==='great' && topMbti===targetMbti){
      line = `\në‹¹ì‹ ì€ <b>${topMbti}</b>ì™€ ì‚¬ê·ˆ ìˆ˜ ìˆì„ ê²ƒ ê°™ë„¤ìš”.`;
    } else if(tier==='fail' && topMbti!==targetMbti){
      line = `\n<b>${topMbti}</b> ê³¼ ì†Œê°œíŒ…í•˜ëŠ”ê²Œ ì–´ë•Œìš”?`;
    }
  }

  m.innerHTML = (dueToStrikes? 'ì¤‘ê°„ì— ì‚ê±±ì˜€ì§€ë§Œ ë¦¬ë“¬ì€ ìœ ì§€í–ˆì–´ìš”.' : 'ì˜¤ëŠ˜ ì¦ê±°ì› ì–´ìš”.') + line;
  s.textContent = `ìµœì¢… ì—ë„ˆì§€: ${finalScore} Â· ì‹¤ìˆ˜: ${strikes} / ${maxStrikes}`;
  resultModal.classList.remove('hidden');
}

function triggerFinalFX(tier){
  finalLayer.innerHTML = '';
  const cele = document.createElement('div');
  cele.className = 'celebration';
  finalLayer.appendChild(cele);

  const iconsGood = ['ğŸ’–','ğŸŒŸ','ğŸ’«','âœ¨','ğŸ§¡','ğŸ‰'];
  const iconsBad  = ['ğŸ’”','â˜”','âš¡','ğŸª¨'];
  const good = (tier==='great' || tier==='good');
  const icons = good ? iconsGood : iconsBad;

  const N  = good ? 72 : 48;
  const cx = window.innerWidth / 2;
  const cy = window.innerHeight * 0.45;

  for(let i=0;i<N;i++){
    const span = document.createElement('span');
    span.className = 'burst';
    span.textContent = icons[Math.floor(Math.random()*icons.length)];
    span.style.fontSize = (good ? '34px' : '28px');

    const angle = (Math.PI*2*(i/N)) + (Math.random()*0.6-0.3);
    const r = 60 + Math.random()*160;

    span.style.left = (cx + Math.cos(angle)*r) + 'px';
    span.style.top  = (cy + Math.sin(angle)*r) + 'px';
    span.style.animationDelay = (Math.random()*0.5) + 's';
    cele.appendChild(span);
  }
}

function restartGame(){
  score = 100;
  currentRound = 0;
  strikes = 0;
  chosenMbti = [];
  sparkStreak = 0;
  lastTag = null;
  keyBuff = false;

  dialogueArea.innerHTML = '';
  optionsArea.innerHTML = '';
  resultModal.classList.add('hidden');
  gameActive = true;

  updateMeters();
  startGame(true);
}

function resetAll(){
  score = 100;
  currentRound = 0;
  strikes = 0;
  chosenMbti = [];
  sparkStreak = 0;
  lastTag = null;
  keyBuff = false;

  dialogueArea.innerHTML = '';
  optionsArea.innerHTML = '';
  resultModal.classList.add('hidden');
  gameActive = true;

  updateMeters();
}

/* ì¤‘ì•™ íŒì—…(ì²« ì¸ì‚¬ ì „ìš©) */
function showPopup(message, duration = 1600, onDone) {
  const popup = document.createElement('div');
  popup.style.position = 'fixed';
  popup.style.top = '50%';
  popup.style.left = '50%';
  popup.style.transform = 'translate(-50%, -50%)';
  popup.style.zIndex = '9999';
  popup.style.display = 'flex';
  popup.style.justifyContent = 'center';
  popup.style.alignItems = 'center';
  popup.style.pointerEvents = 'none';

  const card = document.createElement('div');
  card.style.background = '#fff';
  card.style.border = '2px solid #f8b4c0';
  card.style.borderRadius = '16px';
  card.style.padding = '32px 24px';
  card.style.fontSize = '1.1rem';
  card.style.color = '#c24373';
  card.style.fontWeight = 'bold';
  card.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
  card.style.opacity = '0';
  card.style.transform = 'scale(0.95)';
  card.style.transition = 'all 0.18s ease';
  card.innerHTML = message;

  popup.appendChild(card);
  document.body.appendChild(popup);

  requestAnimationFrame(() => {
    card.style.opacity = '1';
    card.style.transform = 'scale(1)';
  });

  setTimeout(() => {
    card.style.opacity = '0';
    card.style.transform = 'scale(0.95)';
    setTimeout(() => {
      popup.remove();
      if (onDone) onDone();
    }, 180);
  }, duration);
}

function startGame() {
  gameData = buildGameData(targetMbti || 'ENFP');
  updateMeters();

  const hi = GREETINGS[targetMbti || 'ENFP'] || 'ì•ˆë…•í•˜ì„¸ìš”! í¸í•˜ê²Œ ì‹œì‘í•´ìš”.';

  showPopup(hi, 1600, () => {
    renderRound(0);
  });
}

/* ===== ë¶€íŠ¸ìŠ¤íŠ¸ë© (CodePen: JS íŒ¨ë„ ì „ìš©) ===== */
let gameData = [];
document.addEventListener('DOMContentLoaded', () => {
  // DOM refs ì—°ê²°
  launcher     = document.getElementById('launcher');
  row1         = document.getElementById('row1');
  row2         = document.getElementById('row2');
  randomBtn    = document.getElementById('randomBtn');
  gameRoot     = document.getElementById('game-root');
  backBtn      = document.getElementById('backBtn');
  restartBtn   = document.getElementById('restartBtn');
  targetChip   = document.getElementById('target-chip');
  dialogueArea = document.getElementById('dialogue-area');
  optionsArea  = document.getElementById('options-area');
  scoreText    = document.getElementById('score-text');
  scoreBarInner= document.getElementById('score-bar-inner');
  resultModal  = document.getElementById('result-modal');
  strikeBadge  = document.getElementById('strike-badge');
  progressText = document.getElementById('progress-text');
  effectsLayer = document.getElementById('effects-layer');
  finalLayer   = document.getElementById('final-layer');
  toast        = document.getElementById('toast');
  replyPop     = document.getElementById('reply-pop');

  // ëŸ°ì²˜ ë²„íŠ¼ ë™ì‘
  if (backBtn) {
    backBtn.onclick = () => {
      resetAll();
      gameRoot.classList.add('hidden');
      launcher.classList.remove('hidden');
      window.scrollTo({top:0,behavior:'smooth'});
    };
  }
  if (restartBtn) {
    restartBtn.onclick = () => {
      resultModal.classList.add('hidden');
      gameRoot.classList.add('hidden');
      launcher.classList.remove('hidden');
      targetMbti = null;
      resetAll();
      window.scrollTo({top:0, behavior:'smooth'});
    };
  }

  // ì´ˆê¸° ê°€ì‹œì„±
  if (launcher) launcher.classList.remove('hidden');
  if (gameRoot) gameRoot.classList.add('hidden');

  // ëŸ°ì²˜ êµ¬ì„±
  buildLauncher();
});
  </script>
</body>
</html>
