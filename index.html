<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MBTI 소개팅 게임 — 런처/대화 팝업 통합 빌드</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet"/>
  <meta name="mobile-web-app-capable" content="yes"/>
  <style>
    :root{ --pink-50:#fff1f5; --pink-100:#ffe4ec; --pink-200:#ffc9da; --pink-300:#ffabc7; --pink-400:#ff8fb5; --pink-500:#ff6a9a; --pink-600:#e45487; --pink-700:#c24373; }
    html,body{height:100%}
    body{font-family:'Noto Sans KR',sans-serif; background: radial-gradient(1200px 600px at 50% -10%, var(--pink-100), transparent), linear-gradient(180deg, var(--pink-50), #fff);}    
    .soft-card{ background:#fff; border:1px solid #f3e5ea; border-radius:1.25rem; box-shadow:0 12px 30px rgba(255,106,154,0.08);}  
    .chip{ background: var(--pink-100); color:#b4235b; }
    .btn-pink{ background: var(--pink-500); color:#fff; }
    .btn-pink:hover{ background: var(--pink-600);} 
    .dialogue-bubble{ position:relative; background:#fff; border:1px solid #f3e5ea; border-radius:.9rem; padding:1.4rem 1.2rem; max-width:80%; align-self:flex-start; } /* 위아래 여백 확장 */
    #effects-layer{ position:absolute; inset:0; pointer-events:none; overflow:hidden; }
    .badge{ font-variant-numeric: tabular-nums; }
    .particle{ position:absolute; width:18px; height:18px; opacity:0; will-change: transform, opacity; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.15));}
    .particle.pos{ animation: rise .9s ease-out forwards; }
    .particle.neg{ animation: fall .9s cubic-bezier(.2,.8,.2,1) forwards; }
    @keyframes rise{ 0%{opacity:0; transform: translate(var(--x,0), var(--y,0)) scale(.6);} 15%{opacity:1;} 100%{opacity:0; transform: translate(calc(var(--x)*1.4), calc(var(--y) - 90px)) scale(1.05);} }
    @keyframes fall{ 0%{opacity:0; transform: translate(var(--x,0), var(--y,0)) scale(.9);} 10%{opacity:1;} 100%{opacity:0; transform: translate(calc(var(--x)*1.2), calc(var(--y) + 100px)); } }
    #final-layer{ position:fixed; inset:0; pointer-events:none; z-index:70; overflow:hidden; }
    .celebration{ position:fixed; inset:0; pointer-events:none; }
    .celebration .burst{ position:absolute; font-size:28px; animation: pop2 1.2s ease-out forwards; }
    @keyframes pop2{ 0%{ transform: scale(.6); opacity:0;} 20%{opacity:1;} 100%{ transform: scale(1.35) translateY(-10px); opacity:0;} }
    #toast{ position:fixed; left:50%; transform:translateX(-50%); bottom:20px; display:flex; flex-direction:column; align-items:center; pointer-events:none; z-index:80; }
    .toast-item{ padding:.7rem 1.05rem; border-radius:9999px; color:#fff; font-weight:800; box-shadow:0 8px 24px rgba(0,0,0,.12); opacity:0; transform:translateY(10px); transition:all .25s ease; font-size:15px; letter-spacing:.2px; margin-top:.35rem; }
    .toast-item.show{ opacity:1; transform:translateY(0);} 
    #reply-pop{ position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); z-index:85; pointer-events:none; }
    .reply-card{ background:#fff; border:1px solid #f3e5ea; border-radius:1rem; padding:1rem 1.2rem; box-shadow:0 12px 30px rgba(0,0,0,.12); max-width:90vw; width:22rem; opacity:0; transform:translateY(8px); transition: all .22s ease; text-align:center; }
    .reply-card.show{ opacity:1; transform:translateY(0); }
  </style>
</head>
<body class="min-h-screen p-4">
<div id="toast"></div>
<div id="reply-pop"></div>
<div id="final-layer"></div>

<section id="launcher" class="max-w-md mx-auto space-y-5">
  <header class="text-center space-y-3">
    <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full chip text-sm font-bold">소개팅 시뮬레이터</div>
    <h1 class="text-3xl font-extrabold text-[#c24373] tracking-tight">오늘은 누구랑 설레볼까요?</h1>
    <p class="text-gray-600">원하는 MBTI를 고르고 시작하세요.</p>
  </header>
  <div class="soft-card p-4 space-y-4">
    <div class="grid grid-cols-4 gap-2" id="row1"></div>
    <div class="grid grid-cols-4 gap-2" id="row2"></div>
    <button id="randomBtn" type="button" class="w-full btn-pink font-bold py-3 rounded-xl">랜덤 매칭</button>
  </div>
</section>

<section id="game-root" class="hidden max-w-md mx-auto mt-5">
  <div id="game-container" class="relative soft-card p-6 space-y-5">
    <div class="flex items-center justify-between">
      <button id="backBtn" class="text-sm text-[#c24373] hover:underline" type="button">← MBTI 선택으로</button>
      <div class="text-right"><span id="target-chip" class="inline-flex items-center text-xs font-bold px-2 py-1 rounded-full chip"></span></div>
    </div>

    <div id="effects-layer"></div>

    <div class="space-y-2">
      <div class="flex justify-between items-center"><span class="text-sm font-bold text-gray-600">현재 에너지</span><span id="score-text" class="text-lg font-bold text-[#e45487]">100 / 200</span></div>
      <div class="w-full bg-pink-100 rounded-full h-3"><div id="score-bar-inner" class="h-3 rounded-full" style="width: 50%; background: linear-gradient(90deg, var(--pink-300), var(--pink-500));"></div></div>
      <div class="flex justify-between items-center"><div class="flex items-center gap-2"><span class="text-sm text-gray-600">실수</span><span id="strike-badge" class="badge text-xs px-2 py-1 rounded-full bg-pink-50 border">0 / 3</span></div><div class="text-sm text-gray-500"><span id="progress-text">1 / 5</span></div></div>
    </div>

    <div id="dialogue-area" class="space-y-3 min-h-[120px] max-h-[220px] flex flex-col overflow-hidden"></div>
    <div id="options-area" class="space-y-3"></div>

    <div id="result-modal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50">
      <div class="soft-card p-8 text-center space-y-4 max-w-sm w-full">
        <div id="result-icon"></div>
        <h2 id="result-title" class="text-3xl font-bold"></h2>
        <p id="result-message" class="text-gray-700 whitespace-pre-line"></p>
        <p id="result-score" class="text-xl font-bold"></p>
        <button id="restartBtn" class="w-full btn-pink font-bold py-3 rounded-xl" type="button">런처로 돌아가기</button>
      </div>
    </div>
  </div>
</section> 

<script>
'use strict';

// ===== 전역 효과음 선언(파일 경로를 쓰는 경우) =====
const sfxClick = new Audio('sounds/click.mp3');
sfxClick.preload = 'auto';

/* ========== 전역 상태/DOM ========== */
const MBTIS = ["ENFP","ENFJ","ENTP","ENTJ","ESFP","ESFJ","ESTP","ESTJ","INFP","INFJ","INTP","INTJ","ISFP","ISFJ","ISTP","ISTJ"];
let targetMbti = null; 
let score = 100, currentRound = 0, strikes = 0, gameActive = true; 
const maxStrikes = 3; 
let chosenMbti = []; 
let sparkStreak = 0, lastTag = null, keyBuff = false;

// DOM refs
let launcher,row1,row2,randomBtn,gameRoot,backBtn,restartBtn,targetChip,dialogueArea,optionsArea,scoreText,scoreBarInner,resultModal,strikeBadge,progressText,effectsLayer,finalLayer,toast,replyPop;

/* ========== 런처 ========== */
function addBtn(type, row){
  const b = document.createElement('button');
  b.type = 'button';
  b.className = 'w-full bg-white border border-pink-200 rounded-xl py-3 px-2 hover:border-pink-400 hover:bg-pink-50 text-[#c24373] font-bold';
  b.textContent = '💌 ' + type;
  b.onclick = () => selectTarget(type);
  row.appendChild(b);
}
function buildLauncher(){
  if(row1 && !row1.childElementCount) MBTIS.slice(0,8).forEach(t=>addBtn(t,row1));
  if(row2 && !row2.childElementCount) MBTIS.slice(8).forEach(t=>addBtn(t,row2));
  if(randomBtn && !randomBtn.__bound){ 
    randomBtn.onclick = () => selectTarget(MBTIS[Math.floor(Math.random()*MBTIS.length)]);
    randomBtn.__bound = true;
  }
}
function selectTarget(type){
  targetMbti = type;
  targetChip.innerHTML = `상대 MBTI: <b>${type}</b>`;
  resetAll();
  launcher.classList.add('hidden');
  gameRoot.classList.remove('hidden');

  // 오디오 해제 안전망(한 번만)
  if(!AudioKit.unlocked){
    try { AudioKit.resume(); AudioKit.prime(); } catch(_) {}
  }

  startGame();
}

/* ========== 질문/옵션(요약) ========== */
// (질문/옵션/템플릿/GREETINGS는 네가 준 그대로 유지)
const QUESTIONS = { /* ... 그대로 ... */ };
const PERSONA_OPTIONS = { /* ... 그대로 ... */ };
const OPTION_TEMPLATES = { /* ... 그대로 ... */ };
const GREETINGS = { /* ... 그대로 ... */ };

/* ========== 데이터 빌드/렌더 공용 ========== */
function buildGameData(type){
  const qs = QUESTIONS[type] || QUESTIONS.ENFP;
  const persona = PERSONA_OPTIONS[type];
  const scorePos=[18,16,14,16,20], scoreNeg=[-12,-12,-12,-10,-12];
  if(persona){
    return qs.map((q,i)=>{
      const opts = persona[i].map((o)=>({
        tag:o.tag, text:o.text, reply:o.reply,
        score: o.tag==='spark'?scorePos[i]: o.tag==='trap'?scoreNeg[i]: 6,
        grantsKey: i===0 && o.tag==='spark'
      }));
      return { q, opts };
    });
  }
  return qs.map((q,i)=>({ q, opts:[
    {tag:'spark',score:scorePos[i],text:OPTION_TEMPLATES.spark[i],reply:'좋아요!',grantsKey:i===0},
    {tag:'safe', score:6,text:OPTION_TEMPLATES.safe[i],reply:'무난하네요.'},
    {tag:'trap', score:scoreNeg[i],text:OPTION_TEMPLATES.trap[i],reply:'조금 딱딱해요.'}
  ] }));
}

function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }

function addDialogue(text, isPlayer=false){
  while(dialogueArea.childElementCount > 1){ dialogueArea.removeChild(dialogueArea.firstElementChild); }
  const row=document.createElement('div'); row.className='w-full flex';
  const bubble=document.createElement('div'); bubble.textContent=text; bubble.className='dialogue-bubble';
  if(isPlayer){ row.classList.add('justify-end'); bubble.style.background='var(--pink-500)'; bubble.style.color='#fff'; bubble.style.border='none'; bubble.style.borderBottomRightRadius='.35rem'; }
  else { row.classList.add('justify-start'); bubble.style.background='#ffffff'; bubble.style.color='#1f2937'; bubble.style.border='1px solid #f3e5ea'; bubble.style.borderBottomLeftRadius='.35rem'; }
  row.appendChild(bubble); dialogueArea.appendChild(row); dialogueArea.scrollTop=dialogueArea.scrollHeight;
}

function updateMeters(){ 
  score=Math.max(0,Math.min(200,score)); 
  scoreText.textContent=`${score} / 200`; 
  scoreBarInner.style.width=`${score/2}%`; 
  strikeBadge.textContent=`${strikes} / ${maxStrikes}`; 
  progressText.textContent=`${Math.min(currentRound+1,gameData.length)} / ${gameData.length}`; 
}

function renderRound(idx){
  optionsArea.innerHTML=''; 
  const round=gameData[idx];
  setTimeout(()=>{ 
    addDialogue(round.q); 
    shuffle([...round.opts]).forEach(opt=>{
      const btn=document.createElement('button'); 
      btn.textContent=opt.text; 
      const tagStyle = opt.tag==='spark' ? 'bg-pink-50 border-pink-300 hover:bg-pink-100 text-[#b4235b]' : opt.tag==='safe' ? 'bg-amber-50 border-amber-300 hover:bg-amber-100 text-[#7a4b00]' : 'bg-gray-50 border-gray-300 hover:bg-gray-100 text-gray-700'; 
      btn.className = `w-full text-left p-4 rounded-xl font-medium border ${tagStyle}`; 
      btn.onclick=()=>handleOption(opt); 
      optionsArea.appendChild(btn); 
    }); 
  },200);
}

/* ========== 사운드/토스트/파티클 ========== */
const AudioKit = (()=>{ 
  const ctx = new (window.AudioContext||window.webkitAudioContext)(); let unlocked=false; 
  function resume(){ if(ctx.state!=='running'){ ctx.resume(); } unlocked=true; } 
  function env(node,{a=0.003,d=0.22,s=0.0001,r=0.12,peak=0.7}={}){ const t=ctx.currentTime; node.gain.cancelScheduledValues(t); node.gain.setValueAtTime(0.0001,t); node.gain.linearRampToValueAtTime(peak,t+a); node.gain.exponentialRampToValueAtTime(Math.max(0.0001,peak*s),t+a+d); node.gain.setTargetAtTime(0.0001,t+a+d,r);} 
  function mallet({freq=880,dur=0.28}={}){ const g=ctx.createGain(); env(g,{}); const bp=ctx.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value=freq*2; bp.Q.value=6; const lpf=ctx.createBiquadFilter(); lpf.type='lowpass'; lpf.frequency.value=4200; lpf.Q.value=.7; const o1=ctx.createOscillator(); o1.type='sine'; o1.frequency.value=freq; const o2=ctx.createOscillator(); o2.type='triangle'; o2.frequency.value=freq*2.66; const o3=ctx.createOscillator(); o3.type='sine'; o3.frequency.value=freq*3.98; o1.connect(g); o2.connect(g); o3.connect(g); g.connect(bp); bp.connect(lpf); lpf.connect(ctx.destination); const now=ctx.currentTime; [o1,o2,o3].forEach(o=>{o.start(now); o.stop(now+dur);}); return new Promise(r=>o3.onended=r);} 
  async function xylophoneSuccess(){ const base=880; await mallet({freq:base}); await mallet({freq:base*1.333}); await mallet({freq:base*1.781}); } 
  async function meh(){ await mallet({freq:523,dur:.2}); } 
  async function fail(){ await mallet({freq:220,dur:.3}); await mallet({freq:175,dur:.32}); } 
  function prime(){ const g = ctx.createGain(); g.gain.value = 0.0001; const o = ctx.createOscillator(); o.type = 'sine'; o.frequency.value = 440; o.connect(g); g.connect(ctx.destination); const now = ctx.currentTime; o.start(now); o.stop(now + 0.05); }
  return { resume, xylophoneSuccess, meh, fail, prime, get unlocked(){return unlocked;} };
})();

function spawnBurst(kind='pos', strength=6){ const count=Math.max(4,Math.min(14,Math.round(strength))); const rect=effectsLayer.getBoundingClientRect(); const centerX=rect.width/2; const baseY=rect.height*0.88; for(let i=0;i<count;i++){ const el=document.createElement('div'); el.className=`particle ${kind}`; const icon = kind==='pos' ? (Math.random()<.5?ICONS.heart:ICONS.spark) : (Math.random()<.6?ICONS.broken:ICONS.shard); el.innerHTML=icon; const angle=(Math.random()*80-40); const dist=40+Math.random()*40; const x=Math.cos(angle*Math.PI/180)*dist; const y=Math.sin(angle*Math.PI/180)*(kind==='pos'?-dist:dist); const rot=(Math.random()*120-60)+'deg'; const size=14+Math.random()*10+'px'; const dur=(700+Math.random()*600)+'ms'; el.style.left=(centerX-10+(Math.random()*20-10))+'px'; el.style.top=baseY+'px'; el.style.setProperty('--x',x+'px'); el.style.setProperty('--y',y+'px'); el.style.setProperty('--rot',rot); el.style.setProperty('--size',size); el.style.setProperty('--dur',dur); effectsLayer.appendChild(el); setTimeout(()=>el.remove(),1200);} }
function addScore(delta){ if(!delta) return; score+=delta; if(delta>0) spawnBurst('pos', Math.min(12,4+delta/2)); else spawnBurst('neg', Math.min(12,4+Math.abs(delta)/2)); }
function showToast(msg, kind='meh'){ const el=document.createElement('div'); el.className='toast-item'; el.style.background = kind==='ok'?'#16a34a':kind==='bad'?'#ef4444':'#64748b'; el.textContent=msg; toast.appendChild(el); requestAnimationFrame(()=>el.classList.add('show')); setTimeout(()=>{ el.classList.remove('show'); setTimeout(()=>el.remove(),250); },1200); }
function showReply(text){ replyPop.innerHTML=''; const card=document.createElement('div'); card.className='reply-card'; card.innerHTML = `💬 ${text}`; replyPop.appendChild(card); requestAnimationFrame(()=>card.classList.add('show')); setTimeout(()=>{ card.classList.remove('show'); setTimeout(()=>{ replyPop.innerHTML=''; },200); }, 1300); }

const ICONS = { heart:`<svg viewBox="0 0 24 24" fill="#ef4444" xmlns="http://www.w3.org/2000/svg"><path d="M12 21s-6.716-4.297-9.192-7.23C.69 11.36 1.127 7.9 3.757 6.33A5.2 5.2 0 0 1 12 7.2a5.2 5.2 0 0 1 8.243-.87c2.63 1.57 3.066 5.03.95 7.44C18.716 16.703 12 21 12 21z"/></svg>`, spark:`<svg viewBox="0 0 24 24" fill="#f59e0b" xmlns="http://www.w3.org/2000/svg"><path d="M12 2l2.2 5.8L20 10l-5.8 2.2L12 18l-2.2-5.8L4 10l5.8-2.2L12 2z"/></svg>`, broken:`<svg viewBox="0 0 24 24" fill="#9ca3af" xmlns="http://www.w3.org/2000/svg"><path d="M12 21s-6.716-4.297-9.192-7.23C.69 11.36 1.127 7.9 3.757 6.33c1.29-.77 2.77-.93 4.12-.54L10 9l-2 3 3 2-1 3 2 1 2-4-3-2 1-3 2-2a5.2 5.2 0 0 1 3.12.06c2.63 1.57 3.066 5.03.95 7.44C18.716 16.703 12 21 12 21z"/></svg>`, shard:`<svg viewBox="0 0 24 24" fill="#6b7280" xmlns="http://www.w3.org/2000/svg"><path d="M4 14l6-10 4 6-6 10-4-6z"/></svg>` };

/* ========== 규칙/흐름 ========== */
function isFType(type){ return type && type[2] === 'F'; }
function decorateReplyForType(type, base, tag){
  if(!isFType(type)) return base;
  if(tag === 'spark') return `${base} 설레요, 지금 이 느낌 계속 가요`;
  if(tag === 'safe')  return `${base} 편안해서 좋아요`;
  if(tag === 'trap')  return `${base} 음… 조금 아쉬웠어요. 다음은 우리 템포로 가요.`;
  return base;
}

function applyHidden(opt){
  if(opt.tag === 'spark'){
    sparkStreak += 1;
    if(sparkStreak >= 2){ addScore(6); showToast('콤보 보너스 +6','ok'); }
  } else { sparkStreak = 0; }
  if(opt.grantsKey){ keyBuff = true; }
  else if(keyBuff && opt.tag === 'spark'){ addScore(4); keyBuff = false; showToast('키 시너지 +4','ok'); }
  if(lastTag === 'trap' && opt.tag === 'trap'){ strikes += 1; addScore(-4); showToast('연속 실수 -4','bad'); }
  lastTag = opt.tag;
}

function charmDelta(opt){
  const isFinal = currentRound === gameData.length - 1; if(isFinal) return;
  if(opt.tag === 'spark'){ showToast('매력이 상승했다','ok'); try{ AudioKit.xylophoneSuccess(); }catch(_e){} }
  else if(opt.tag === 'trap'){ showToast('매력이 감소했다','bad'); try{ AudioKit.fail(); }catch(_e){} }
  else { showToast('매력이 유지됐다','meh'); try{ AudioKit.meh(); }catch(_e){} }
}

// 모바일 첫 클릭에서 실제 소리 1회 재생 보장 + 실패 시 WebAudio 대체
function handleOption(opt){
  if(!AudioKit.unlocked){
    try {
      AudioKit.resume();
      AudioKit.prime();
      sfxClick.currentTime = 0;
      sfxClick.play().catch(()=>AudioKit.meh());
    } catch(_e){}
  }

  if(!gameActive) return;

  addDialogue(opt.text, true);
  optionsArea.innerHTML = '<div class="text-center text-gray-500 animate-pulse">답변 중…</div>';

  setTimeout(()=>{
    addScore(opt.score);
    if(opt.tag === 'trap') strikes += 1;
    chosenMbti.push(targetMbti);
    applyHidden(opt);
    updateMeters();
    charmDelta(opt);

    const replyText = decorateReplyForType(targetMbti, opt.reply, opt.tag);
    showReply(replyText);

    currentRound++;
    const out = currentRound >= gameData.length;
    const tooMany = strikes >= maxStrikes;

    if(out || tooMany){
      endGame(score, tooMany && !out);
    } else {
      renderRound(currentRound);
    }
  }, 650);
}

function endGame(finalScore, dueToStrikes=false){
  gameActive = false;
  if (replyPop) replyPop.innerHTML = '';

  const t = document.getElementById('result-title');
  const m = document.getElementById('result-message');
  const s = document.getElementById('result-score');
  const iconEl = document.getElementById('result-icon');

  let tier = 'fail';
  if(finalScore >= 165) tier = 'great';
  else if(finalScore >= 125) tier = 'good';
  else if(finalScore >= 95)  tier = 'meh';

  t.textContent = (tier==='great')? '애프터 대성공'
                : (tier==='good') ? '애프터 신청 각'
                : (tier==='meh')  ? '여지 있음'
                : '상대방이 날 차단했어요.';

  if(iconEl){
    iconEl.textContent = (tier==='fail') ? '💔' : (tier==='meh') ? '🙂' : '💖';
    iconEl.style.fontSize = '44px';
  }
  if(tier !== 'fail'){ triggerFinalFX(tier); }

  const mbtiCount = chosenMbti.reduce((acc,t)=>{ acc[t]=(acc[t]||0)+1; return acc; },{});
  const topMbti = Object.entries(mbtiCount).sort((a,b)=>b[1]-a[1])[0]?.[0];

  let line = '';
  if(topMbti){
    if(tier==='great' && topMbti===targetMbti){
      line = `\n당신은 <b>${topMbti}</b>와 사귈 수 있을 것 같네요.`;
    } else if(tier==='fail' && topMbti!==targetMbti){
      line = `\n<b>${topMbti}</b> 과 소개팅하는게 어때요?`;
    }
  }

  m.innerHTML = (dueToStrikes? '중간에 삐걱였지만 리듬은 유지했어요.' : '오늘 즐거웠어요.') + line;
  s.textContent = `최종 에너지: ${finalScore} · 실수: ${strikes} / ${maxStrikes}`;
  resultModal.classList.remove('hidden');
}

function triggerFinalFX(tier){
  finalLayer.innerHTML = '';
  const cele = document.createElement('div'); cele.className = 'celebration'; finalLayer.appendChild(cele);
  const iconsGood = ['💖','🌟','💫','✨','🧡','🎉']; const iconsBad  = ['💔','☔','⚡','🪨'];
  const good = (tier==='great' || tier==='good'); const icons = good ? iconsGood : iconsBad;
  const N  = good ? 72 : 48; const cx = window.innerWidth / 2; const cy = window.innerHeight * 0.45;
  for(let i=0;i<N;i++){
    const span = document.createElement('span'); span.className = 'burst'; span.textContent = icons[Math.floor(Math.random()*icons.length)];
    span.style.fontSize = (good ? '34px' : '28px');
    const angle = (Math.PI*2*(i/N)) + (Math.random()*0.6-0.3); const r = 60 + Math.random()*160;
    span.style.left = (cx + Math.cos(angle)*r) + 'px'; span.style.top  = (cy + Math.sin(angle)*r) + 'px';
    span.style.animationDelay = (Math.random()*0.5) + 's'; cele.appendChild(span);
  }
}

function restartGame(){
  score = 100; currentRound = 0; strikes = 0; chosenMbti = []; sparkStreak = 0; lastTag = null; keyBuff = false;
  dialogueArea.innerHTML = ''; optionsArea.innerHTML = ''; resultModal.classList.add('hidden'); gameActive = true;
  updateMeters(); startGame(true);
}

function resetAll(){
  score = 100; currentRound = 0; strikes = 0; chosenMbti = []; sparkStreak = 0; lastTag = null; keyBuff = false;
  dialogueArea.innerHTML = ''; optionsArea.innerHTML = ''; resultModal.classList.add('hidden'); gameActive = true;
  updateMeters();
}

/* 중앙 팝업 */
function showPopup(message, duration = 1600, onDone) {
  const popup = document.createElement('div');
  popup.style.position = 'fixed'; popup.style.top = '50%'; popup.style.left = '50%';
  popup.style.transform = 'translate(-50%, -50%)'; popup.style.zIndex = '9999';
  popup.style.display = 'flex'; popup.style.justifyContent = 'center'; popup.style.alignItems = 'center';
  popup.style.pointerEvents = 'none';
  const card = document.createElement('div');
  card.style.background = '#fff'; card.style.border = '2px solid #f8b4c0'; card.style.borderRadius = '16px';
  card.style.padding = '32px 24px'; card.style.fontSize = '1.1rem'; card.style.color = '#c24373'; card.style.fontWeight = 'bold';
  card.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)'; card.style.opacity = '0'; card.style.transform = 'scale(0.95)'; card.style.transition = 'all 0.18s ease';
  card.innerHTML = message; popup.appendChild(card); document.body.appendChild(popup);
  requestAnimationFrame(() => { card.style.opacity = '1'; card.style.transform = 'scale(1)'; });
  setTimeout(() => { card.style.opacity = '0'; card.style.transform = 'scale(0.95)'; setTimeout(() => { popup.remove(); if (onDone) onDone(); }, 180); }, duration);
}

function startGame() {
  gameData = buildGameData(targetMbti || 'ENFP');
  updateMeters();
  const hi = GREETINGS[targetMbti || 'ENFP'] || '안녕하세요! 편하게 시작해요.';
  showPopup(hi, 1600, () => { renderRound(0); });
}

/* ===== 전역 오디오 해제 바인딩(한 번만) ===== */
function bindAudioUnlock(){
  let done = false;
  const tryUnlock = () => {
    if (done) return; done = true;
    try { AudioKit.resume(); AudioKit.prime(); } catch(_) {}
    ['touchstart','pointerdown','click'].forEach(t=>document.removeEventListener(t, tryUnlock, true));
  };
  ['touchstart','pointerdown','click'].forEach(t=>document.addEventListener(t, tryUnlock, true));
}

let gameData = [];
document.addEventListener('DOMContentLoaded', () => {
  launcher     = document.getElementById('launcher');
  row1         = document.getElementById('row1');
  row2         = document.getElementById('row2');
  randomBtn    = document.getElementById('randomBtn');
  gameRoot     = document.getElementById('game-root');
  backBtn      = document.getElementById('backBtn');
  restartBtn   = document.getElementById('restartBtn');
  targetChip   = document.getElementById('target-chip');
  dialogueArea = document.getElementById('dialogue-area');
  optionsArea  = document.getElementById('options-area');
  scoreText    = document.getElementById('score-text');
  scoreBarInner= document.getElementById('score-bar-inner');
  resultModal  = document.getElementById('result-modal');
  strikeBadge  = document.getElementById('strike-badge');
  progressText = document.getElementById('progress-text');
  effectsLayer = document.getElementById('effects-layer');
  finalLayer   = document.getElementById('final-layer');
  toast        = document.getElementById('toast');
  replyPop     = document.getElementById('reply-pop');

  if (backBtn) backBtn.onclick = () => { resetAll(); gameRoot.classList.add('hidden'); launcher.classList.remove('hidden'); window.scrollTo({top:0,behavior:'smooth'}); };
  if (restartBtn) restartBtn.onclick = () => { resultModal.classList.add('hidden'); gameRoot.classList.add('hidden'); launcher.classList.remove('hidden'); targetMbti = null; resetAll(); window.scrollTo({top:0, behavior:'smooth'}); };

  if (launcher) launcher.classList.remove('hidden');
  if (gameRoot) gameRoot.classList.add('hidden');

  buildLauncher();
  bindAudioUnlock(); // 전역 오디오 해제 바인딩
});
</script>
</body>
</html>
